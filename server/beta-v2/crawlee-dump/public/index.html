
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crawlee Dump Service</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            padding: 30px;
        }

        .form-section {
            background: #f8fafc;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 25px;
            border: 2px solid #e2e8f0;
        }

        .form-section h3 {
            color: #1e293b;
            margin-bottom: 20px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
        }

        .form-section h3::before {
            content: "⚙️";
            margin-right: 10px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #374151;
            font-weight: 600;
        }

        .input-group input[type="text"], 
        .input-group input[type="number"] {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #d1d5db;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.2s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .slider-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .slider-item {
            background: white;
            padding: 20px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }

        .slider-item label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #374151;
        }

        .slider-item input[type="range"] {
            width: 100%;
            margin-bottom: 10px;
        }

        .slider-value {
            text-align: center;
            font-weight: bold;
            color: #4f46e5;
            font-size: 1.1rem;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .checkbox-group input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2);
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 25px;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(79, 70, 229, 0.3);
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        .status-section {
            background: white;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 25px;
            border: 2px solid #e2e8f0;
            display: none;
        }

        .status-section.show {
            display: block;
        }

        .status-section h3 {
            margin-bottom: 15px;
            color: #1e293b;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e5e7eb;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4f46e5, #7c3aed);
            border-radius: 10px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .status-text {
            font-weight: 600;
            color: #374151;
            margin-bottom: 10px;
        }

        .results-section {
            background: white;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 25px;
            border: 2px solid #e2e8f0;
            display: none;
        }

        .results-section.show {
            display: block;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: #f1f5f9;
            padding: 20px;
            border-radius: 6px;
            text-align: center;
            border: 1px solid #e2e8f0;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #4f46e5;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #64748b;
            font-weight: 600;
        }

        .url-list {
            background: #f8fafc;
            border-radius: 6px;
            padding: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .url-item {
            padding: 8px 0;
            border-bottom: 1px solid #e2e8f0;
            color: #374151;
        }

        .url-item:last-child {
            border-bottom: none;
        }

        .error {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
        }

        .success {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            color: #16a34a;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4f46e5;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .dumps-list {
            background: white;
            border-radius: 8px;
            padding: 25px;
            border: 2px solid #e2e8f0;
        }

        .dumps-list h3 {
            margin-bottom: 20px;
            color: #1e293b;
        }

        .dump-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            margin-bottom: 10px;
            background: #f8fafc;
        }

        .dump-info {
            flex: 1;
        }

        .dump-domain {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 5px;
        }

        .dump-meta {
            font-size: 0.9rem;
            color: #64748b;
        }

        .dump-actions {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Crawlee Dump Service</h1>
            <p>Advanced web crawling with session management and network capture</p>
        </div>

        <div class="main-content">
            <!-- Configuration Form -->
            <div class="form-section">
                <h3>Crawl Configuration</h3>
                
                <div class="input-group">
                    <label for="domainInput">Domain to Crawl</label>
                    <input type="text" id="domainInput" placeholder="example.com" />
                </div>

                <div class="slider-group">
                    <div class="slider-item">
                        <label for="maxPages">Maximum Pages</label>
                        <input type="range" id="maxPages" min="1" max="100" value="10" />
                        <div class="slider-value" id="maxPagesValue">10</div>
                    </div>

                    <div class="slider-item">
                        <label for="maxDepth">Maximum Depth</label>
                        <input type="range" id="maxDepth" min="1" max="5" value="2" />
                        <div class="slider-value" id="maxDepthValue">2</div>
                    </div>

                    <div class="slider-item">
                        <label for="waitTime">Wait Time (ms)</label>
                        <input type="range" id="waitTime" min="100" max="5000" value="1000" step="100" />
                        <div class="slider-value" id="waitTimeValue">1000ms</div>
                    </div>
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" id="captureNetwork" />
                    <label for="captureNetwork">Enable Network Request Capture (uses Playwright)</label>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-primary" id="startCrawl">
                        <span id="crawlButtonText">🚀 Start Crawl</span>
                    </button>
                    <button class="btn btn-secondary" id="refreshDumps">
                        📋 Refresh Dumps
                    </button>
                </div>
            </div>

            <!-- Status Section -->
            <div class="status-section" id="statusSection">
                <h3>Crawl Progress</h3>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="status-text" id="statusText">Initializing crawl...</div>
            </div>

            <!-- Results Section -->
            <div class="results-section" id="resultsSection">
                <h3>Crawl Results</h3>
                <div class="results-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="pagesCrawled">0</div>
                        <div class="stat-label">Pages Crawled</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalSize">0 MB</div>
                        <div class="stat-label">Total Size</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="timeTaken">0s</div>
                        <div class="stat-label">Time Taken</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="cleanedPages">0</div>
                        <div class="stat-label">LLM Cleaned</div>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-primary" id="downloadResults" style="display: none;">
                        💾 Download Results
                    </button>
                    <button class="btn btn-secondary" id="viewData" style="display: none;">
                        👁️ View Data
                    </button>
                </div>

                <div class="url-list" id="urlList" style="display: none;">
                    <h4>Crawled URLs:</h4>
                    <div id="urlItems"></div>
                </div>
            </div>

            <!-- Existing Dumps -->
            <div class="dumps-list">
                <h3>Recent Crawlee Dumps</h3>
                <div id="dumpsList">
                    <div class="status-text">Loading dumps...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class CrawleeDumpUI {
            constructor() {
                this.currentDumpId = null;
                this.pollInterval = null;
                this.initializeElements();
                this.bindEvents();
                this.updateSliderValues();
                this.loadExistingDumps();
            }

            initializeElements() {
                this.elements = {
                    domainInput: document.getElementById('domainInput'),
                    maxPages: document.getElementById('maxPages'),
                    maxDepth: document.getElementById('maxDepth'),
                    waitTime: document.getElementById('waitTime'),
                    captureNetwork: document.getElementById('captureNetwork'),
                    startCrawl: document.getElementById('startCrawl'),
                    refreshDumps: document.getElementById('refreshDumps'),
                    statusSection: document.getElementById('statusSection'),
                    resultsSection: document.getElementById('resultsSection'),
                    progressFill: document.getElementById('progressFill'),
                    statusText: document.getElementById('statusText'),
                    pagesCrawled: document.getElementById('pagesCrawled'),
                    totalSize: document.getElementById('totalSize'),
                    timeTaken: document.getElementById('timeTaken'),
                    cleanedPages: document.getElementById('cleanedPages'),
                    downloadResults: document.getElementById('downloadResults'),
                    viewData: document.getElementById('viewData'),
                    urlList: document.getElementById('urlList'),
                    urlItems: document.getElementById('urlItems'),
                    dumpsList: document.getElementById('dumpsList'),
                    crawlButtonText: document.getElementById('crawlButtonText')
                };
            }

            bindEvents() {
                // Slider updates
                this.elements.maxPages.addEventListener('input', () => this.updateSliderValues());
                this.elements.maxDepth.addEventListener('input', () => this.updateSliderValues());
                this.elements.waitTime.addEventListener('input', () => this.updateSliderValues());

                // Button events
                this.elements.startCrawl.addEventListener('click', () => this.startCrawl());
                this.elements.refreshDumps.addEventListener('click', () => this.loadExistingDumps());
                this.elements.downloadResults.addEventListener('click', () => this.downloadResults());
                this.elements.viewData.addEventListener('click', () => this.viewData());
            }

            updateSliderValues() {
                document.getElementById('maxPagesValue').textContent = this.elements.maxPages.value;
                document.getElementById('maxDepthValue').textContent = this.elements.maxDepth.value;
                document.getElementById('waitTimeValue').textContent = this.elements.waitTime.value + 'ms';
            }

            async startCrawl() {
                const domain = this.elements.domainInput.value.trim();
                if (!domain) {
                    this.showError('Please enter a domain to crawl');
                    return;
                }

                const config = {
                    maxPages: parseInt(this.elements.maxPages.value),
                    maxDepth: parseInt(this.elements.maxDepth.value),
                    waitTime: parseInt(this.elements.waitTime.value),
                    captureNetworkRequests: this.elements.captureNetwork.checked
                };

                try {
                    this.setLoading(true);
                    this.elements.statusSection.classList.add('show');
                    this.elements.resultsSection.classList.remove('show');

                    const response = await fetch('/api/beta/crawlee-dump/dump', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ domain, config })
                    });

                    const data = await response.json();

                    if (data.id) {
                        this.currentDumpId = data.id;
                        this.showSuccess('Crawl started successfully! ID: ' + data.id);
                        this.startPolling();
                    } else {
                        throw new Error(data.error || 'Failed to start crawl');
                    }

                } catch (error) {
                    this.showError('Error starting crawl: ' + error.message);
                    this.setLoading(false);
                }
            }

            startPolling() {
                this.elements.statusText.textContent = 'Crawling in progress...';
                this.pollInterval = setInterval(async () => {
                    await this.checkCrawlStatus();
                }, 2000);
            }

            async checkCrawlStatus() {
                if (!this.currentDumpId) return;

                try {
                    const response = await fetch(`/api/beta/crawlee-dump/dump/${this.currentDumpId}`);
                    const dump = await response.json();

                    if (dump.status === 'completed') {
                        this.handleCrawlComplete(dump);
                    } else if (dump.status === 'failed') {
                        this.handleCrawlError(dump.errorMessage || 'Crawl failed');
                    } else {
                        this.updateProgress(dump);
                    }

                } catch (error) {
                    console.error('Error checking crawl status:', error);
                }
            }

            handleCrawlComplete(dump) {
                clearInterval(this.pollInterval);
                this.setLoading(false);
                
                this.elements.progressFill.style.width = '100%';
                this.elements.statusText.textContent = 'Crawl completed successfully!';
                
                this.showResults(dump);
                this.loadExistingDumps();
            }

            handleCrawlError(errorMessage) {
                clearInterval(this.pollInterval);
                this.setLoading(false);
                this.showError('Crawl failed: ' + errorMessage);
            }

            updateProgress(dump) {
                // Estimate progress based on processing time (rough estimate)
                const progress = Math.min(80, (Date.now() - new Date(dump.createdAt).getTime()) / 1000);
                this.elements.progressFill.style.width = progress + '%';
                this.elements.statusText.textContent = `Crawling... (${dump.status})`;
            }

            showResults(dump) {
                this.elements.resultsSection.classList.add('show');
                
                const stats = dump.dumpData?.crawlStats || {};
                const cleanedCount = dump.dumpData?.cleanedPages?.length || 0;
                
                this.elements.pagesCrawled.textContent = stats.pagesCrawled || 0;
                this.elements.totalSize.textContent = this.formatBytes(stats.totalSizeBytes || 0);
                this.elements.timeTaken.textContent = this.formatTime(stats.timeTakenMs || 0);
                this.elements.cleanedPages.textContent = cleanedCount;

                this.elements.downloadResults.style.display = 'inline-flex';
                this.elements.viewData.style.display = 'inline-flex';

                // Show URLs if available
                if (dump.dumpData?.pages?.length > 0) {
                    this.showUrls(dump.dumpData.pages);
                }
            }

            showUrls(pages) {
                this.elements.urlList.style.display = 'block';
                this.elements.urlItems.innerHTML = pages.map(page => 
                    `<div class="url-item">${page.url}</div>`
                ).join('');
            }

            async loadExistingDumps() {
                try {
                    const response = await fetch('/api/beta/crawlee-dump/dumps');
                    const dumps = await response.json();

                    if (dumps && dumps.length > 0) {
                        this.renderDumps(dumps);
                    } else {
                        this.elements.dumpsList.innerHTML = '<div class="status-text">No dumps available</div>';
                    }

                } catch (error) {
                    this.elements.dumpsList.innerHTML = '<div class="error">Error loading dumps</div>';
                }
            }

            renderDumps(dumps) {
                this.elements.dumpsList.innerHTML = dumps.slice(0, 10).map(dump => `
                    <div class="dump-item">
                        <div class="dump-info">
                            <div class="dump-domain">${dump.domain}</div>
                            <div class="dump-meta">
                                Status: ${dump.status} | 
                                Pages: ${dump.pagesCrawled || 0} | 
                                Size: ${this.formatBytes(dump.totalSizeBytes || 0)} |
                                Created: ${new Date(dump.createdAt).toLocaleString()}
                            </div>
                        </div>
                        <div class="dump-actions">
                            <button class="btn btn-secondary btn-small" onclick="crawleeUI.viewDump(${dump.id})">
                                View
                            </button>
                            <button class="btn btn-secondary btn-small" onclick="crawleeUI.downloadDump(${dump.id})">
                                Download
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            async viewDump(dumpId) {
                try {
                    const response = await fetch(`/api/beta/crawlee-dump/dump/${dumpId}`);
                    const dump = await response.json();
                    
                    if (dump.dumpData) {
                        this.showResults(dump);
                        document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
                    }
                } catch (error) {
                    this.showError('Error loading dump data');
                }
            }

            async downloadDump(dumpId) {
                window.open(`/api/beta/crawlee-dump/dump/${dumpId}/data`, '_blank');
            }

            async downloadResults() {
                if (this.currentDumpId) {
                    this.downloadDump(this.currentDumpId);
                }
            }

            async viewData() {
                if (this.currentDumpId) {
                    this.viewDump(this.currentDumpId);
                }
            }

            setLoading(loading) {
                this.elements.startCrawl.disabled = loading;
                this.elements.crawlButtonText.innerHTML = loading 
                    ? '<span class="spinner"></span> Crawling...'
                    : '🚀 Start Crawl';
            }

            showError(message) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error';
                errorDiv.textContent = message;
                document.querySelector('.main-content').insertBefore(errorDiv, document.querySelector('.form-section'));
                
                setTimeout(() => errorDiv.remove(), 5000);
            }

            showSuccess(message) {
                const successDiv = document.createElement('div');
                successDiv.className = 'success';
                successDiv.textContent = message;
                document.querySelector('.main-content').insertBefore(successDiv, document.querySelector('.form-section'));
                
                setTimeout(() => successDiv.remove(), 5000);
            }

            formatBytes(bytes) {
                if (bytes === 0) return '0 B';
                const k = 1024;
                const sizes = ['B', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            formatTime(ms) {
                if (ms < 1000) return ms + 'ms';
                return (ms / 1000).toFixed(1) + 's';
            }
        }

        // Initialize the UI
        const crawleeUI = new CrawleeDumpUI();
    </script>
</body>
</html>
